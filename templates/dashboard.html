{% extends 'base.html' %}

{% block title %}Dashboard - FinAdapter{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
    <!-- Sync Card -->
    <div>
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Trigger Data Sync</h2>
            </div>
            <p class="text-muted text-sm" style="margin-bottom: 1.5rem;">
                Initiate the ingestion pipeline (Airflow DAG) to fetch data from External Bank into our Postgres and
                ClickHouse warehouse.
            </p>

            <form id="syncForm">
                <div class="form-group">
                    <label>Tenant</label>
                    {% if request.user.is_superuser %}
                    <select name="tenant_id" required>
                        <option value="BANK001">BANK001</option>
                        <option value="BANK002">BANK002</option>
                        <option value="BANK003">BANK003</option>
                    </select>
                    {% else %}
                    {% with code=request.session.active_tenant|default:request.user.tenant_link.tenant.tenant_code %}
                    <select name="tenant_id" required disabled>
                        <option value="{{ code }}">{{ code }}</option>
                    </select>
                    <input type="hidden" name="tenant_id" value="{{ code }}">
                    {% endwith %}
                    {% endif %}
                </div>

                <div class="form-group">
                    <label>Loan Type</label>
                    <select name="loan_type" required>
                        <option value="RETAIL">Retail Loans</option>
                        <option value="COMMERCIAL">Commercial Loans</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Dataset Type</label>
                    <select name="dataset_type" required>
                        <option value="CREDIT">Credit Mask</option>
                        <option value="PAYMENT_PLAN">Payment Plan</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary" style="background: var(--success); width: 100%;">
                    Start Sync Process
                </button>
            </form>
            <div id="syncResult" class="mt-4"></div>
        </div>

        <!-- Recent Batches List (Placeholder for now, could be dynamic) -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Recent Batches</h2>
                <button class="btn btn-primary" onclick="loadRecentBatches()"
                    style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">Refresh</button>
            </div>
            <div id="batchesList" class="text-sm">
                <p class="text-muted">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Live Status Monitor -->
    <div>
        <div class="card" id="statusCard" style="border-top: 4px solid var(--text-muted);">
            <div class="card-header">
                <h2 class="card-title">Live Batch Monitor</h2>
                <span class="badge" id="monitorStatus" style="background: #e5e7eb; color: #374151;">Idle</span>
            </div>
            <div id="monitorContent"
                style="min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                <p class="text-muted">Start a sync to view live progress.</p>
            </div>
            <div id="errorDetails" class="d-none"
                style="margin-top: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                <h4 style="font-size: 0.9rem;">Validation Errors</h4>
                <div id="errorTableContainer" class="table-container" style="max-height: 200px; overflow-y: auto;">
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const getCookie = (name) => {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.getElementById('syncForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        btn.disabled = true;
        btn.innerText = 'Starting...';

        const formData = new FormData(e.target);
        const payload = {
            tenant_id: formData.get('tenant_id'),
            loan_type: formData.get('loan_type'),
            dataset_type: formData.get('dataset_type')
        };

        try {
            const res = await fetch('/api/sync/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if (res.ok) {
                // Start monitoring
                startMonitoring(data.id || data.batch_id);
            } else {
                alert('Error: ' + (data.error || JSON.stringify(data)));
            }
        } catch (err) {
            console.error(err);
            alert('Network Error');
        } finally {
            btn.disabled = false;
            btn.innerText = 'Start Sync Process';
        }
    };

    let monitorInterval = null;

    function startMonitoring(batchId) {
        if (monitorInterval) clearInterval(monitorInterval);

        const card = document.getElementById('statusCard');
        const badge = document.getElementById('monitorStatus');
        const content = document.getElementById('monitorContent');
        const errorDetails = document.getElementById('errorDetails');

        card.style.borderColor = 'var(--text-muted)';
        badge.innerText = 'Polling...';
        badge.style.background = '#e0f2fe';
        badge.style.color = '#0369a1';

        content.innerHTML = `<div style="font-size: 2rem; margin-bottom: 0.5rem;">Processed: <span id="mCount">0</span></div>
                             <div class="text-muted text-sm">Valid: <span id="mValid" style="color: var(--success)">0</span> | Invalid: <span id="mInvalid" style="color: var(--danger)">0</span></div>
                             <div class="text-muted text-sm" style="margin-top: 0.5rem">Status: <span id="mStatus">WAITING</span></div>`;

        errorDetails.classList.add('d-none');

        const poll = async () => {
            try {
                const res = await fetch(`/api/batches/${batchId}/`);
                if (!res.ok) return;
                const data = await res.json();

                document.getElementById('mCount').innerText = data.total_rows || data.record_count;
                document.getElementById('mValid').innerText = data.valid_rows;
                document.getElementById('mInvalid').innerText = data.invalid_rows;
                document.getElementById('mStatus').innerText = data.status;

                if (data.status === 'SUCCESS') {
                    card.style.borderColor = 'var(--success)';
                    badge.innerText = 'Completed';
                    badge.style.background = '#dcfce7';
                    badge.style.color = '#15803d';
                    clearInterval(monitorInterval);
                    loadRecentBatches();
                } else if (data.status === 'FAILED' || data.status === 'FAILED_VALIDATION') {
                    card.style.borderColor = 'var(--danger)';
                    badge.innerText = 'Failed';
                    badge.style.background = '#fee2e2';
                    badge.style.color = '#b91c1c';
                    clearInterval(monitorInterval);
                    loadRecentBatches();

                    if (data.invalid_rows > 0) {
                        loadErrors(batchId);
                    }
                } else {
                    card.style.borderColor = 'var(--info)';
                }

            } catch (e) {
                console.error(e);
            }
        };

        monitorInterval = setInterval(poll, 1000);
        poll(); // immediate
    }

    async function loadErrors(batchId) {
        const container = document.getElementById('errorTableContainer');
        const section = document.getElementById('errorDetails');
        section.classList.remove('d-none');
        container.innerHTML = 'Loading errors...';

        const res = await fetch(`/api/batches/${batchId}/errors/`);
        const errors = await res.json();

        if (errors.length === 0) {
            container.innerHTML = '<p class="text-sm text-muted">No specific error details found.</p>';
            return;
        }

        let html = '<table><thead><tr><th>Row</th><th>Code</th><th>Msg</th></tr></thead><tbody>';
        errors.forEach(e => {
            html += `<tr><td>${e.row_number}</td><td><span class="badge badge-warning">${e.error_code}</span></td><td>${e.message}</td></tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    async function loadRecentBatches() {
        const div = document.getElementById('batchesList');
        // div.innerHTML = 'Loading...'; 
        try {
            const res = await fetch('/api/batches/');
            const data = await res.json();

            if (data.length === 0) {
                div.innerHTML = '<p class="text-muted">No batches found.</p>';
                return;
            }

            let html = '<table><thead><tr><th>ID</th><th>Tenant</th><th>Type</th><th>Status</th><th>Time</th></tr></thead><tbody>';
            data.slice(0, 5).forEach(b => {
                const date = new Date(b.created_at).toLocaleTimeString();
                let statusColor = '#6b7280';
                if (b.status === 'SUCCESS') statusColor = 'var(--success)';
                if (b.status === 'FAILED') statusColor = 'var(--danger)';
                if (b.status === 'PROCESSING') statusColor = 'var(--info)';

                html += `<tr>
                    <td><a href="#" onclick="startMonitoring('${b.id}'); return false;">${b.id.substring(0, 8)}...</a></td>
                    <td>${b.tenant_id}</td>
                    <td>${b.loan_type}</td>
                    <td style="color: ${statusColor}; font-weight: 600;">${b.status}</td>
                    <td>${date}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            div.innerHTML = html;
        } catch (e) {
            console.error(e);
            div.innerHTML = '<p class="text-danger">Failed to load history.</p>';
        }
    }

    // Load history on start
    loadRecentBatches();
</script>
{% endblock %}